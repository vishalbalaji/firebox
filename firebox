#!/bin/sh
# shellcheck disable=2235,2002,2015

NAME=$(basename "$0")

print_log() {
	echo "$NAME: $1" >&2
}

# TODO: add usage for service and workspace
usage() {
	cat <<eof
Usage: $NAME <command> <action>

Options:
	-h, --help   Print this help text and exit

Commands:
	init         Initialize new profile for PWA
	service      Commands relating to Services
	workspace    Commands relating to Workspaces
	delete       Delete all related files
eof
}

[ $# -eq 0 ] && usage && exit 0

command=""

case "$1" in
-h | --help)
	usage
	exit 0
	;;
*)
	command="$1"
	shift
	;;
esac

# Script start

profile_name="$NAME"
profile_dir="$HOME/.local/share/$profile_name"
services_file="$profile_dir/$profile_name-services"
workspaces_file="$profile_dir/$profile_name-workspaces"

init() {
	[ -d "$profile_dir" ] &&
		print_log "Profile already exists." &&
		exit 1

	firefox -CreateProfile "$profile_name $profile_dir"

  # user.js
  # BUG:  Find a way to disable Mozilla start page on first launch
  # TODO: Find better config to hide the 'firefox-view' page

	cat <<eof >"$profile_dir/user.js"
user_pref("toolkit.legacyUserProfileCustomizations.stylesheets", true);
user_pref("extensions.activeThemeID", "firefox-compact-dark@mozilla.org");
user_pref("browser.toolbars.bookmarks.visibility", "never");
user_pref("browser.sessionstore.restore_tabs_lazily", "never");
user_pref("browser.sessionstore.resume_from_crash", "never");
user_pref("browser.sessionstore.restore_on_demand", "never");

user_pref("browser.uiCustomization.state", "{\"placements\":{\"widget-overflow-fixed-list\":[\"_af37054b-3ace-46a2-ac59-709e4412bec6_-browser-action\",\"_de22fd49-c9ab-4359-b722-b3febdc3a0b0_-browser-action\",\"_d10d0bf8-f5b5-c8b4-a8b2-2b9879e08c5d_-browser-action\",\"_1bce6a35-61f2-4477-9899-842359eadcef_-browser-action\",\"playbackspeed_waldemar_b-browser-action\",\"_a8332c60-5b6d-41ee-bfc8-e9bb331d34ad_-browser-action\",\"browsec_browsec_com-browser-action\"],\"nav-bar\":[\"back-button\",\"forward-button\",\"stop-reload-button\",\"customizableui-special-spring15\",\"urlbar-container\",\"customizableui-special-spring16\",\"_446900e4-71c2-419f-a6a7-df9c091e268b_-browser-action\",\"cookieautodelete_kennydo_com-browser-action\",\"addon_darkreader_org-browser-action\",\"downloads-button\",\"history-panelmenu\",\"sync-button\",\"preferences-button\"],\"toolbar-menubar\":[\"menubar-items\"],\"TabsToolbar\":[\"tabbrowser-tabs\",\"new-tab-button\",\"alltabs-button\"],\"PersonalToolbar\":[\"import-button\",\"personal-bookmarks\"]},\"seen\":[\"save-to-pocket-button\",\"developer-button\",\"_c961a5ba-dc89-44e9-9e52-93318dd95378_-browser-action\",\"browsec_browsec_com-browser-action\",\"_af37054b-3ace-46a2-ac59-709e4412bec6_-browser-action\",\"_287dcf75-bec6-4eec-b4f6-71948a2eea29_-browser-action\",\"dontfuckwithpaste_raim_ist-browser-action\",\"_setupvpncom-browser-action\",\"cookieautodelete_kennydo_com-browser-action\",\"playbackspeed_waldemar_b-browser-action\",\"_1bce6a35-61f2-4477-9899-842359eadcef_-browser-action\",\"_d10d0bf8-f5b5-c8b4-a8b2-2b9879e08c5d_-browser-action\",\"jid1-zadieub7xozojw_jetpack-browser-action\",\"_c2c003ee-bd69-42a2-b0e9-6f34222cb046_-browser-action\",\"addon_darkreader_org-browser-action\",\"enhancerforyoutube_maximerf_addons_mozilla_org-browser-action\",\"_762f9885-5a13-4abd-9c77-433dcd38b8fd_-browser-action\",\"_41f9e51d-35e4-4b29-af66-422ff81c8b41_-browser-action\",\"firefox-webext_zenmate_com-browser-action\",\"_de22fd49-c9ab-4359-b722-b3febdc3a0b0_-browser-action\",\"tab-stash_condordes_net-browser-action\",\"_a8332c60-5b6d-41ee-bfc8-e9bb331d34ad_-browser-action\",\"_446900e4-71c2-419f-a6a7-df9c091e268b_-browser-action\"],\"dirtyAreaCache\":[\"nav-bar\",\"PersonalToolbar\",\"widget-overflow-fixed-list\",\"toolbar-menubar\",\"TabsToolbar\"],\"currentVersion\":18,\"newElementCount\":18}");
eof

	# userChrome.css
	mkdir -p "$profile_dir/chrome"
	cat <<eof >"$profile_dir/chrome/userChrome.css"
@namespace url("http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul"); /* set default namespace to XUL */
browser {margin-right: -14px; margin-bottom: -14px;}

#nav-bar {visibility: collapse;}

.tab-label-container, .tab-close-button { display: none !important }
.tabbrowser-tab {min-width: 35px !important; -moz-box-flex: 0 !important; }
.tab-icon-overlay {
	opacity: 1 !important;
	stroke: var(--tab-icon-overlay-stroke) !important;
	top: -5.5px !important;
	inset-inline-end: -6px !important;
	padding: 2px !important;
	z-index: 1 !important;
}
eof

	echo "Profile '$profile_name' created at: $profile_dir."
}

create_service() {
	[ ! -f "$services_file" ] &&
		touch "$services_file"

	grep -qiEw "^<\|$profile_name:$1\|>" "$services_file" &&
		print_log "Service '$1' already exists." &&
		exit 1

	echo "<|$profile_name:$1|><|sep|>$2" >>"$services_file"
	print_log "Created service: $1"
}

get_search_query() {
	query=""

	for i in "$@"; do
		grep -qiEw "^<\|$profile_name:$i\|>" "$services_file" &&
			query="$query<\|$profile_name:$i\|>|" ||
			print_log "Service '$i' does not exist. Ignoring..."
	done

	echo "$query" | sed 's/|$//'
}

get_services() {
	if [ -z "$1" ]; then
		echo ''
	elif [ "$1" = "--all" ]; then
		cat "$services_file"
	else
		grep -iEw "^($1)" "$services_file" | sed 's/.*<|sep|>//g'
	fi
}

launch_services() {
	urls=""

	if [ "$(echo "$1" | wc -l)" -gt 1 ]; then
		urls="$(echo "$1" | sed -z 's/\n/ /g;s/^\s*//;s/\s*$//')"
	else
		urls="-new-window $1"
	fi

	# shellcheck disable=2116,2046
	firefox -P "$profile_name" --class "pwa" $(echo "$urls")
}

service() {
	([ "$1" != "create" ] && [ ! -f "$services_file" ]) &&
		print_log "No services available. Run '$NAME service create' to create a service." &&
		exit 1

	action="$1"
	shift

	case "$action" in

	create)
		[ "$#" -ne 2 ] &&
			print_log "Invalid format for command." &&
			usage &&
			exit 1

		# TODO: URL validation for $2

		create_service "$1" "$2"
		;;

	list)
		[ "$#" -gt 1 ] &&
			print_log "Unkown argument: '$1'" &&
			usage &&
			exit 1

		([ "$1" != "--raw" ] && [ "$1" != "" ]) &&
			print_log "Invalid argument: '$1'" &&
			usage &&
			exit 1

		[ "$1" = "--raw" ] &&
			get_services "--all" ||
			get_services "--all" | sed "s/<|sep|>/ | /g;s/<|$profile_name://g;s/|>//g"
		;;

	launch)
		[ "$1" = "--all" ] &&
			urls="$(get_services --all | sed 's/.*<|sep|>//g')" ||
			urls="$(get_services "$(get_search_query "$@")")"

		[ -n "$urls" ] &&
			launch_services "$urls" ||
			(print_log "No valid services provided. Exiting..." && exit 1)
		;;

	delete)
		[ "$#" -ne 1 ] &&
			print_log "Only one service can be deleted a time." &&
			usage &&
			exit 1

		if [ "$1" = "--all" ]; then
			printf "%s" "$profile_name: Are you sure you want to delete all your services? (y/N): "
			read -r confirm
			case "$confirm" in
			y | Y)
				rm "$services_file" &&
					print_log "All services deleted."
				;;
			*)
				print_log "No services deleted."
				;;
			esac

		else
			services="$(get_services "$(get_search_query "$1")")"

			if [ -n "$services" ]; then
				sed -in "/^<|$profile_name:$1|>/Id" "$services_file" &&
					print_log "Service '$1' deleted"

				[ "$(cat "$services_file" | wc -l)" -eq 0 ] && rm "$services_file"
			fi

		fi
		;;

	*)
		print_log "Invalid action: '$action'"
		usage
		exit 1
		;;

	esac
}

delete() {
	print_log "You can delete the newly created profile and all associated data"
	print_log "from Firefox's profile manager by running 'firefox -ProfileManager'."
}

workspace() {
  echo "$workspaces_file"
}

test() {
	echo "hello"
}

([ "$command" != "init" ] && [ "$command" != "test" ] && [ ! -d "$profile_dir" ]) &&
	print_log "App not initialized. run '$profile_name init' before running a command." &&
	exit 1

([ "$command" = "init" ] && [ "$#" -gt 0 ]) &&
	print_log "Unrecognized action '$1'" &&
	usage &&
	exit 1

case "$command" in

init | service | workspace | delete | test)
	"$command" "$@"
	;;
*)
	print_log "Invalid Option '$command'"
	usage
	exit 1
	;;
esac
